# 通用可视化平台 - 开发路线图

> **目标**：构建一个跨领域的知识过程可视化平台，让 AI 和用户通过声明式 DSL 创建可视化课程

---

## 📍 项目定位

### 核心目标
- **跨领域**：支持图形学/算法/数学/物理/ML/系统架构等
- **声明式**：Lesson 只写 DSL，不写 Three.js 代码
- **AI 友好**：DSL 可由 AI 生成/修改（patch）
- **多视图联动**：3D + Graph + Inspector/Plot
- **时间轴编辑器**：可视化编排讲解节奏

### 成功标准
1. 新增 lesson：只写 DSL 文件即可运行
2. 时间线编辑器可拖拽关键帧/marker，保存回 DSL
3. 至少 5 个跨领域示例课程
4. DSL 错误不崩溃，语义级错误提示

---

## 🎯 里程碑计划

### 📦 Milestone A：平台壳 + 多视图 Host（2 周）

**目标**：搭建 Shell 布局 + 多视图容器 + Selection 联动

**交付物**：
- [x] Shell 布局
  - [x] 左侧：课程目录树
  - [x] 中央：ViewHost 区域（3D + Graph 双栏）
  - [x] 右侧：Inspector 面板
  - [x] 底部：Timeline Bar + 可展开 Timeline Editor 区域
- [x] ViewHost 系统
  - [x] `views/ViewManager.ts` - 视图管理器
  - [x] `views/View3D.ts` - Three.js 3D 视图
  - [x] `views/GraphView.ts` - 2D 图视图（Canvas 2D）
  - [x] `views/InspectorView.ts` - 表格/属性视图
  - [x] `views/PlotView.ts` - 曲线视图（占位）
- [x] Selection 联动
  - [x] `semantic/SelectionStore.ts` - 选中状态管理
  - [x] 点击实体 → 高亮 + Inspector 显示属性
  - [x] 跨视图联动（Graph 选中 → 3D + Inspector 同步）

**验收标准**：
- 一个最小 demo：Node/Edge 图 + 3D 点同时存在，点击联动

---

### 🧩 Milestone B：积木 v0（跨领域最小集合）（3 周）

**目标**：实现通用实体/关系/过程积木，验证跨领域复用

**交付物**：

#### B1. 实体积木（Entities）
- [x] `core/gizmos/entities/NodeGizmo.ts` - 图节点（球体 + billboard 标签）
- [x] `core/gizmos/entities/LinkGizmo.ts` - 图边（线段）
- [x] `core/gizmos/entities/PointGizmo.ts` - 3D 点
- [x] `core/gizmos/entities/ArrowGizmo.ts` - 向量箭头
- [x] `core/gizmos/entities/SymbolGizmo.ts` - 通用语义符号（camera/light/target/...）
- [x] `core/gizmos/entities/LabelGizmo.ts` - 文本标签
- [x] `core/gizmos/entities/MarkerGizmo.ts` - 标记点
- [x] `core/gizmos/entities/BadgeGizmo.ts` - 数值小标签

#### B2. 关系积木（Relations）
- [x] `core/gizmos/relations/MeasureDistanceGizmo.ts` - 距离测量
- [x] `core/gizmos/relations/MeasureAngleGizmo.ts` - 角度测量
- [x] `core/gizmos/relations/ProjectionHelperGizmo.ts` - 投影线/垂足
- [x] `core/gizmos/relations/IntersectionMarkerGizmo.ts` - 交点标记

#### B3. 过程积木（Process）
- [x] `core/gizmos/process/StepSequenceGizmo.ts` - 步骤点串
- [x] `core/gizmos/process/StateOverlayGizmo.ts` - 状态显示
- [x] `core/gizmos/process/TraceTrailGizmo.ts` - 轨迹

#### B4. Gizmo 基础设施
- [x] `core/gizmos/BaseGizmo.ts` - Gizmo 基类
- [x] `core/gizmos/GizmoFactory.ts` - Gizmo 工厂
- [x] IGizmo 接口定义

**验收标准**：
- 用同一套积木做出 2 个 demo：
  1. 点积投影（几何）- Arrow + MeasureAngle + ProjectionHelper
  2. BFS（图算法）- Node + Edge + StepSequence + StateOverlay

---

### ⏱️ Milestone C：Timeline Runtime + Editor v0（3 周）

**目标**：实现时间轴运行时 + 可视化编辑器

**交付物**：

#### C1. Timeline Runtime
- [x] `timeline/runtime/TimelineRuntime.ts` - 播放控制
  - [x] play() / pause() / stop() / seek()
  - [x] setSpeed() / setLoop()
  - [x] mode: 'continuous' | 'stepped'
  - [x] nextStep() / prevStep() / gotoStep()
- [x] `timeline/runtime/Track.ts` - 轨道基类
- [x] `timeline/runtime/PropertyTrack.ts` - 属性轨道
- [x] `timeline/runtime/EventTrack.ts` - 事件轨道
- [x] `timeline/runtime/StepTrack.ts` - 步骤轨道
- [x] `timeline/runtime/StateTrack.ts` - 状态轨道
- [x] `timeline/tracks/TrackEvaluator.ts` - 轨道求值器

#### C2. Timeline Editor UI
- [x] `timeline/ui/TimelineEditorUI.ts` - 编辑器主界面（Canvas 2D，含轨道列表 + 标尺）
- [x] `timeline/ui/TimelineBar.ts` - 播放控制条（play/pause/stop/prev/next/scrubber/expand）
- [x] Marker 拖拽 + 双击新增 + 编辑
- [x] Playhead 拖拽 seek
- [x] Step 控制按钮（上一步/下一步）
- [x] 展开/收起 Timeline Editor 面板（Shell 集成）
- [x] Keyframe 拖拽 + 数值编辑
- [x] TrackList 独立组件
- [x] Ruler 独立组件

#### C3. 保存机制
- [x] 保存回 DSL（timeline 部分）
- [x] 或保存为 patch（增量修改）

**验收标准**：
- BFS 可逐步播放/回退/跳转 step
- marker 跟随时间显示解释文本
- 拖拽 marker 后保存，重新加载位置正确

---

### 📝 Milestone D：DSL v0 + Compiler + Validator + Patch（4 周）

**目标**：实现声明式 DSL，让 Lesson 只写配置文件
> 进度更新（2026-02-26）：`BindingManager` 产物已接入运行链路，`ViewManager` 按 view type 分发语义图。

**交付物**：

#### D1. DSL Schema
- [x] `dsl/schema/lesson-schema.json` - JSON Schema 定义
- [x] 支持字段：
  - [x] meta（id/title/tags/level/order）
  - [x] entities（id/type/anchor/direction/color/label）
  - [x] relations（id/type/vectorA/vectorB/...）
  - [x] process（type/config）
  - [x] views（id/type/camera/overlays）
  - [x] ui（sliders/toggles/buttons）
  - [x] timeline（duration/markers/tracks）

#### D2. DSL Parser & Compiler
- [x] `semantic/compiler/DSLParser.ts` - YAML/JSON 解析
- [x] `semantic/compiler/DSLCompiler.ts` - 编译器
  - [x] parse → SemanticGraph
  - [x] validate → 语义检查
  - [x] resolve anchors → 锚点解析
  - [x] build bindings → 视图对象绑定
  - [x] build timeline → 时间轴构建

#### D3. Validator（面向 AI 的报错）
- [x] `semantic/validator/DSLValidator.ts` - 验证器
- [x] 错误类型：
  - [x] MISSING_REFERENCE（引用不存在的实体）
  - [x] INVALID_ANCHOR（未知锚点函数）
  - [x] TYPE_MISMATCH（类型不匹配）
  - [x] CIRCULAR_DEPENDENCY（循环依赖）
- [x] 错误格式：type/code/message/location/suggestion

#### D4. Anchor System
- [x] `semantic/anchors/AnchorResolver.ts` - 锚点解析器
- [x] `semantic/anchors/AnchorFunctions.ts` - 锚点函数库
  - [x] center - 场景中心
  - [x] camera - 相机位置
  - [x] intersection(ray, plane) - 交点
  - [x] closest_point(point, line) - 最近点
  - [x] project(vectorA, vectorB) - 投影

#### D5. Patch System
- [x] `dsl/patch/PatchApplier.ts` - Patch 应用器
- [x] 支持操作：add / remove / replace / move
- [x] JSON Pointer 路径

#### D6. 示例 DSL
- [x] `dsl/examples/vector-dot.yaml` - 点积投影
- [x] `dsl/examples/bfs.yaml` - BFS
- [x] `dsl/examples/gradient-descent.yaml` - 梯度下降
- [x] `dsl/examples/dag-schedule.yaml` - DAG 调度
- [x] `dsl/examples/ray-intersection.yaml` - 射线相交
- [x] `dsl/templates/lesson-starter.yaml` - 新课程起步模板（含 symbol + views + ui）
- [x] `dsl/templates/symbol-catalog.yaml` - 通用符号清单模板

**验收标准**：
- 新 lesson：只新增一个 DSL 文件即可运行
- DSL 写错：报语义错误不中断
- patch 可新增 marker/改 keyframe

---

### 🔄 Milestone E：Process 模型（算法/数值/物理）（3 周）

**目标**：实现通用 Process 接口，支持算法步进/数值迭代/物理模拟

> 进度更新（2026-02-26）：已完成 E1、E2、E3（含 Process 状态事件写入 Timeline EventTrack）。

**交付物**：

#### E1. Process 接口
- [x] `semantic/processes/IProcess.ts` - Process 接口
  - [x] init() / step() / run() / reset()
  - [x] state: 'idle' | 'running' | 'paused' | 'completed' | 'failed'
  - [x] currentStep / totalSteps
  - [x] getMetrics() - 可观测量
  - [x] getSnapshot() / restoreSnapshot() - 回放支持

#### E2. 内置 Process 实现
- [x] `semantic/processes/BFSProcess.ts` - BFS 算法
  - [x] visited / frontier / path
  - [x] metrics: visitedCount / frontierSize / depth
- [x] `semantic/processes/GradientDescentProcess.ts` - 梯度下降
  - [x] currentPoint / trajectory
  - [x] metrics: loss / gradientNorm / iteration
- [x] `semantic/processes/RayIntersectionProcess.ts` - 射线相交
  - [x] ray / objects / hits
  - [x] metrics: hitCount / closestT

#### E3. Process 与 Timeline 绑定
- [x] StepTrack 绑定到 Process
- [x] StateTrack 绑定到 Process
- [x] Process 状态变化 → Timeline 事件

**验收标准**：
- BFS 可步进执行，visited/frontier 实时更新
- 梯度下降可迭代，trajectory 实时绘制
- Process 可暂停/恢复/回放

---

### 📊 Milestone F：Field + Plot（解锁数值/ML/物理）（3 周）

**目标**：支持标量场/向量场/曲线绘制
> 进度更新（2026-02-26）：已完成 `VectorFieldGizmo`（箭头网格 + Streamline），并支持 `sample_probe` 采样向量场模长。
> 进度更新（2026-02-26）：已完成一轮“架构对齐审查”高/中优先级修复（DSL 类型诊断、锚点诊断、Timeline 驱动视图、序列化恢复、安全渲染等）。

**交付物**：

#### F1. Field 积木
- [x] `core/gizmos/fields/ScalarFieldGizmo.ts` - 标量场
  - [x] 2D/3D 标量场可视化
  - [x] 统一模式：plane / surface / both
  - [x] 颜色映射（heatmap）
  - [x] 等值线（IsoLine）
- [x] `core/gizmos/fields/VectorFieldGizmo.ts` - 向量场
  - [x] 箭头网格
  - [x] 流线（Streamline）
- [x] `core/gizmos/fields/SampleProbeGizmo.ts` - 鼠标采样
  - [x] 交互式探索场
  - [x] 显示采样点数值

#### F2. Plot View
- [x] `views/PlotView.ts` - 曲线视图
  - [x] 2D 曲线绘制（Canvas/SVG）
  - [x] 多条曲线叠加
  - [x] 坐标轴/网格/标签
  - [x] 缩放/平移
- [ ] 或简化为 Inspector 表格版（先低成本）

**验收标准**：
- 梯度下降：参数点移动 + loss 下降曲线
- 标量场：鼠标移动显示数值
- 向量场：箭头方向/密度可见，流线连续可追踪

---

### 🎓 Milestone G：第一批跨领域示例课程（2 周）

**目标**：验证平台跨领域能力
> 进度更新（2026-02-26）：已完成首批 5 个跨领域示例课程，并补齐课程文档。

**交付物**：
- [x] **几何**：点积投影（vector projection + angle + measure）
- [x] **图算法**：BFS（frontier/visited step-by-step）
- [x] **数值**：梯度下降（loss field + trajectory + loss curve）
- [x] **系统**：DAG 调度（任务依赖 + timeline clips）
- [x] **图形学**：Ray–Plane 最近命中（t 与交点 + state）

**验收标准**：
- [x] 5 个课程全部只用 DSL 实现（`src/dsl/examples/*.yaml`）
- [x] 每个课程有完整文档（`content/lessons/*.md`）
- [x] 跨领域积木复用率 > 70%（按积木实例统计：67/78 = 85.9%）

---

### 🧱 Milestone H：3D 基础几何与参数化建模（2 周）

**目标**：系统补齐点/线/面/模型能力，并统一参数化驱动路径（UI -> Binding -> Semantic -> Gizmo）。
> 进度更新（2026-02-27）：已完成首轮落地（`line/plane/model` + 参数化示例课程 + 文档/审查对齐）。

**交付物**：

#### H1. 新增实体类型（Geometry/Core）
- [x] `line`：线段实体（支持端点或 origin+direction+length 表达）
- [x] `plane`：平面片实体（width/depth/rotation/opacity/wireframe）
- [x] `model`：模型实体（先支持 primitive：box/sphere/cylinder/cone/torus）

#### H2. 编译与校验
- [x] `SemanticGraph.EntityType` 扩展新类型
- [x] `DSLCompiler` 与 `DSLValidator` 对齐新类型白名单
- [x] `GizmoFactory` 完整分发 line/plane/model

#### H3. 参数化与示例
- [x] 新增示例 lesson：覆盖点/线/面/模型参数化联动
- [x] `ui.sliders + bindings + expr` 驱动 line/plane/model 关键属性
- [x] Lesson Controls 接入时间帧：按当前时间写入 keyframe，支持随 playhead 回显
- [x] 文档同步（README/路线图/架构方案/课程文档）

**验收标准**：
- [x] 不写 Three.js 业务代码，仅写 DSL 即可创建点/线/面/模型场景
- [x] 线、面、模型关键属性均可被 slider 和 timeline 轨道驱动
- [x] 编译无类型降级、运行无未知类型静默失败

---

## 📋 第一周任务单（快速启动）

### Week 1：最小可运行原型

**目标**：搭建骨架 + 第一个 DSL 驱动的 demo

#### Day 1-2：项目骨架
- [ ] Vite + TS 项目初始化
- [ ] Shell 布局（左目录/中视窗/右面板/底时间轴占位）
- [ ] ViewHost 基础框架

#### Day 3-4：Gizmo v0 + SemanticGraph
- [ ] BaseGizmo + GizmoFactory
- [ ] Point / Arrow / Label 实现
- [ ] SemanticEntity / SemanticGraph 基础模型
- [ ] SelectionStore（选中联动）

#### Day 5：Timeline v0
- [ ] TimelineRuntime（play/pause/step）
- [ ] Timeline Editor 最小版（markers 列表 + 时间条）

#### Day 6-7：第一个 DSL 示例
- [ ] DSL Parser（最小版，只解析 entities）
- [x] 点积投影 DSL（vector-dot.yaml）
- [x] 编译 DSL → SemanticGraph → Gizmos
- [x] 运行验证

**Week 1 验收**：
- 一个 DSL 文件驱动的点积投影 demo 可运行
- 可点击选中实体，Inspector 显示属性
- Timeline 可播放/暂停

---

## 🎯 优先级排序

### 🔥 P0（核心路径，必须完成）
1. Milestone A - 平台壳 + 多视图
2. Milestone B - 积木 v0
3. Milestone C - Timeline Runtime + Editor
4. Milestone D - DSL + Compiler + Validator
5. Milestone G - 第一批示例课程

### 🔶 P1（重要，尽快完成）
6. Milestone E - Process 模型
7. Milestone F - Field + Plot
8. Milestone H - 3D 基础几何与参数化建模

### 🔷 P2（增强，后续迭代）
9. 输入系统（拖拽/拾取）
10. 资源管理（缓存/复用）
11. 调试工具（Stats/Logger）
12. 性能优化

### 🔹 P3（可选，长期规划）
13. 协作功能（WebSocket 同步）
14. VR/AR 支持
15. Shader 编辑器

---

## 📐 工程规范

### Lesson 开发规范
1. **Lesson 只允许 DSL**，不允许直接写 Three.js 逻辑
2. **禁止硬编码坐标**，使用语义锚点（center/camera/intersection）
3. **所有对象都有稳定 ID**，Selection 与 Binding 依赖 ID
4. **Timeline 只改"展示"，Process 只管"过程"**

### Gizmo 开发规范
1. **必须继承 BaseGizmo**
2. **必须实现 dispose()**（几何/材质/事件监听都释放）
3. **必须支持 updateFromSemantic()**（语义属性更新）
4. **不暴露 Three.js 对象**，只暴露语义接口

### DSL 设计规范
1. **可解析**：JSON Schema 验证
2. **可验证**：语义级错误检查
3. **可 patch**：支持增量修改
4. **错误可读**：面向 AI/作者的错误提示

---

## 📊 成功指标

| 指标 | 目标 | 测量方法 |
|------|------|---------|
| **新增 Lesson 方式** | 只写 DSL 文件 | 验收标准 |
| **跨领域示例数** | ≥ 5 个 | 课程数量 |
| **积木复用率** | > 70% | 代码分析 |
| **DSL 错误处理** | 不崩溃 + 语义提示 | 错误测试 |
| **Timeline 可编辑** | 拖拽 + 保存 | 功能测试 |
| **AI 友好度** | 可生成/patch DSL | AI 测试 |

---

## 🔗 相关文档

- **[架构设计方案.md](./架构设计方案.md)** ⭐ 必读
  - 三层架构详解
  - 积木系统设计
  - DSL 规范
  - Process 模型

---

## 📈 里程碑时间估算

| Milestone | 预计时间 | 依赖 | 风险 |
|-----------|---------|------|------|
| A - 平台壳 + 多视图 | 2 周 | 无 | 低 |
| B - 积木 v0 | 3 周 | A | 中（抽象设计）|
| C - Timeline | 3 周 | B | 中（编辑器 UI）|
| D - DSL + Compiler | 4 周 | C | 高（编译器复杂）|
| E - Process 模型 | 3 周 | D | 中 |
| F - Field + Plot | 3 周 | E | 中 |
| G - 示例课程 | 2 周 | F | 低 |
| H - 3D 基础几何与参数化建模 | 2 周 | G | 中 |

**总计**：核心功能约 22 周（5.5 个月）

---

## 💡 开发建议

### 每新增一个示例，先问：
1. **缺积木还是缺模板？** → 优先补积木/模板
2. **能否用现有积木组合？** → 优先复用
3. **是否需要新 Process 类型？** → 评估通用性

### 常见陷阱
❌ **不要**在 DSL 中硬编码世界坐标
✅ **应该**使用语义锚点（center/camera/intersection）

❌ **不要**在 Gizmo 中暴露 Three.js 对象
✅ **应该**只暴露语义接口（setDirection/setColor）

❌ **不要**在 Timeline 中写算法逻辑
✅ **应该**算法逻辑在 Process，Timeline 只管展示

---

**最后更新**：2026-02-27
**维护者**：开发团队
**版本**：v2.0（通用平台版）
