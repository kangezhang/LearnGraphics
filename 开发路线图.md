# 通用可视化平台 - 开发路线图

> **目标**：构建一个跨领域的知识过程可视化平台，让 AI 和用户通过声明式 DSL 创建可视化课程

---

## 📍 项目定位

### 核心目标
- **跨领域**：支持图形学/算法/数学/物理/ML/系统架构等
- **声明式**：Lesson 只写 DSL，不写 Three.js 代码
- **AI 友好**：DSL 可由 AI 生成/修改（patch）
- **多视图联动**：3D + Graph + Inspector/Plot
- **时间轴编辑器**：可视化编排讲解节奏

### 成功标准
1. 新增 lesson：只写 DSL 文件即可运行
2. 时间线编辑器可拖拽关键帧/marker，保存回 DSL
3. 至少 5 个跨领域示例课程
4. DSL 错误不崩溃，语义级错误提示

---

## 🎯 里程碑计划

### 📦 Milestone A：平台壳 + 多视图 Host（2 周）

**目标**：搭建 Shell 布局 + 多视图容器 + Selection 联动

**交付物**：
- [x] Shell 布局
  - [ ] 左侧：课程目录树
  - [x] 中央：ViewHost 区域（3D + Graph 双栏）
  - [x] 右侧：Inspector 面板
  - [x] 底部：Timeline Bar + 可展开 Timeline Editor 区域
- [x] ViewHost 系统
  - [x] `views/ViewManager.ts` - 视图管理器
  - [x] `views/View3D.ts` - Three.js 3D 视图
  - [x] `views/GraphView.ts` - 2D 图视图（Canvas 2D）
  - [x] `views/InspectorView.ts` - 表格/属性视图
  - [ ] `views/PlotView.ts` - 曲线视图（占位）
- [x] Selection 联动
  - [x] `semantic/SelectionStore.ts` - 选中状态管理
  - [x] 点击实体 → 高亮 + Inspector 显示属性
  - [x] 跨视图联动（Graph 选中 → 3D + Inspector 同步）

**验收标准**：
- 一个最小 demo：Node/Edge 图 + 3D 点同时存在，点击联动

---

### 🧩 Milestone B：积木 v0（跨领域最小集合）（3 周）

**目标**：实现通用实体/关系/过程积木，验证跨领域复用

**交付物**：

#### B1. 实体积木（Entities）
- [x] `core/gizmos/entities/NodeGizmo.ts` - 图节点（球体 + billboard 标签）
- [x] `core/gizmos/entities/LinkGizmo.ts` - 图边（线段）
- [x] `core/gizmos/entities/PointGizmo.ts` - 3D 点
- [x] `core/gizmos/entities/ArrowGizmo.ts` - 向量箭头
- [x] `core/gizmos/entities/LabelGizmo.ts` - 文本标签
- [x] `core/gizmos/entities/MarkerGizmo.ts` - 标记点
- [x] `core/gizmos/entities/BadgeGizmo.ts` - 数值小标签

#### B2. 关系积木（Relations）
- [x] `core/gizmos/relations/MeasureDistanceGizmo.ts` - 距离测量
- [x] `core/gizmos/relations/MeasureAngleGizmo.ts` - 角度测量
- [x] `core/gizmos/relations/ProjectionHelperGizmo.ts` - 投影线/垂足
- [x] `core/gizmos/relations/IntersectionMarkerGizmo.ts` - 交点标记

#### B3. 过程积木（Process）
- [x] `core/gizmos/process/StepSequenceGizmo.ts` - 步骤点串
- [x] `core/gizmos/process/StateOverlayGizmo.ts` - 状态显示
- [x] `core/gizmos/process/TraceTrailGizmo.ts` - 轨迹

#### B4. Gizmo 基础设施
- [x] `core/gizmos/BaseGizmo.ts` - Gizmo 基类
- [x] `core/gizmos/GizmoFactory.ts` - Gizmo 工厂
- [ ] IGizmo 接口定义

**验收标准**：
- 用同一套积木做出 2 个 demo：
  1. 点积投影（几何）- Arrow + MeasureAngle + ProjectionHelper
  2. BFS（图算法）- Node + Edge + StepSequence + StateOverlay

---

### ⏱️ Milestone C：Timeline Runtime + Editor v0（3 周）

**目标**：实现时间轴运行时 + 可视化编辑器

**交付物**：

#### C1. Timeline Runtime
- [x] `timeline/runtime/TimelineRuntime.ts` - 播放控制
  - [x] play() / pause() / stop() / seek()
  - [x] setSpeed() / setLoop()
  - [x] mode: 'continuous' | 'stepped'
  - [x] nextStep() / prevStep() / gotoStep()
- [x] `timeline/runtime/Track.ts` - 轨道基类
- [x] `timeline/runtime/PropertyTrack.ts` - 属性轨道
- [x] `timeline/runtime/EventTrack.ts` - 事件轨道
- [x] `timeline/runtime/StepTrack.ts` - 步骤轨道
- [x] `timeline/runtime/StateTrack.ts` - 状态轨道
- [ ] `timeline/tracks/TrackEvaluator.ts` - 轨道求值器

#### C2. Timeline Editor UI
- [x] `timeline/ui/TimelineEditorUI.ts` - 编辑器主界面（Canvas 2D，含轨道列表 + 标尺）
- [x] `timeline/ui/TimelineBar.ts` - 播放控制条（play/pause/stop/prev/next/scrubber/expand）
- [x] Marker 拖拽 + 双击新增 + 编辑
- [x] Playhead 拖拽 seek
- [x] Step 控制按钮（上一步/下一步）
- [x] 展开/收起 Timeline Editor 面板（Shell 集成）
- [ ] Keyframe 拖拽 + 数值编辑
- [ ] TrackList 独立组件
- [ ] Ruler 独立组件

#### C3. 保存机制
- [ ] 保存回 DSL（timeline 部分）
- [ ] 或保存为 patch（增量修改）

**验收标准**：
- BFS 可逐步播放/回退/跳转 step
- marker 跟随时间显示解释文本
- 拖拽 marker 后保存，重新加载位置正确

---

### 📝 Milestone D：DSL v0 + Compiler + Validator + Patch（4 周）

**目标**：实现声明式 DSL，让 Lesson 只写配置文件

**交付物**：

#### D1. DSL Schema
- [ ] `dsl/schema/lesson-schema.json` - JSON Schema 定义
- [ ] 支持字段：
  - [ ] meta（id/title/tags/level/order）
  - [ ] entities（id/type/anchor/direction/color/label）
  - [ ] relations（id/type/vectorA/vectorB/...）
  - [ ] process（type/config）
  - [ ] views（id/type/camera/overlays）
  - [ ] ui（sliders/toggles/buttons）
  - [ ] timeline（duration/markers/tracks）

#### D2. DSL Parser & Compiler
- [ ] `semantic/compiler/DSLParser.ts` - YAML/JSON 解析
- [ ] `semantic/compiler/DSLCompiler.ts` - 编译器
  - [ ] parse → SemanticGraph
  - [ ] validate → 语义检查
  - [ ] resolve anchors → 锚点解析
  - [ ] build bindings → 视图对象绑定
  - [ ] build timeline → 时间轴构建

#### D3. Validator（面向 AI 的报错）
- [ ] `semantic/validator/DSLValidator.ts` - 验证器
- [ ] 错误类型：
  - [ ] MISSING_REFERENCE（引用不存在的实体）
  - [ ] INVALID_ANCHOR（未知锚点函数）
  - [ ] TYPE_MISMATCH（类型不匹配）
  - [ ] CIRCULAR_DEPENDENCY（循环依赖）
- [ ] 错误格式：type/code/message/location/suggestion

#### D4. Anchor System
- [ ] `semantic/anchors/AnchorResolver.ts` - 锚点解析器
- [ ] `semantic/anchors/AnchorFunctions.ts` - 锚点函数库
  - [ ] center - 场景中心
  - [ ] camera - 相机位置
  - [ ] intersection(ray, plane) - 交点
  - [ ] closest_point(point, line) - 最近点
  - [ ] project(vectorA, vectorB) - 投影

#### D5. Patch System
- [ ] `dsl/patch/PatchApplier.ts` - Patch 应用器
- [ ] 支持操作：add / remove / replace / move
- [ ] JSON Pointer 路径

#### D6. 示例 DSL
- [ ] `dsl/examples/vector-dot.yaml` - 点积投影
- [ ] `dsl/examples/bfs.yaml` - BFS
- [ ] `dsl/examples/gradient-descent.yaml` - 梯度下降
- [ ] `dsl/examples/dag-schedule.yaml` - DAG 调度
- [ ] `dsl/examples/ray-intersection.yaml` - 射线相交

**验收标准**：
- 新 lesson：只新增一个 DSL 文件即可运行
- DSL 写错：报语义错误不中断
- patch 可新增 marker/改 keyframe

---

### 🔄 Milestone E：Process 模型（算法/数值/物理）（3 周）

**目标**：实现通用 Process 接口，支持算法步进/数值迭代/物理模拟

**交付物**：

#### E1. Process 接口
- [ ] `semantic/processes/IProcess.ts` - Process 接口
  - [ ] init() / step() / run() / reset()
  - [ ] state: 'idle' | 'running' | 'paused' | 'completed' | 'failed'
  - [ ] currentStep / totalSteps
  - [ ] getMetrics() - 可观测量
  - [ ] getSnapshot() / restoreSnapshot() - 回放支持

#### E2. 内置 Process 实现
- [ ] `semantic/processes/BFSProcess.ts` - BFS 算法
  - [ ] visited / frontier / path
  - [ ] metrics: visitedCount / frontierSize / depth
- [ ] `semantic/processes/GradientDescentProcess.ts` - 梯度下降
  - [ ] currentPoint / trajectory
  - [ ] metrics: loss / gradientNorm / iteration
- [ ] `semantic/processes/RayIntersectionProcess.ts` - 射线相交
  - [ ] ray / objects / hits
  - [ ] metrics: hitCount / closestT

#### E3. Process 与 Timeline 绑定
- [ ] StepTrack 绑定到 Process
- [ ] StateTrack 绑定到 Process
- [ ] Process 状态变化 → Timeline 事件

**验收标准**：
- BFS 可步进执行，visited/frontier 实时更新
- 梯度下降可迭代，trajectory 实时绘制
- Process 可暂停/恢复/回放

---

### 📊 Milestone F：Field + Plot（解锁数值/ML/物理）（3 周）

**目标**：支持标量场/向量场/曲线绘制

**交付物**：

#### F1. Field 积木
- [ ] `core/gizmos/fields/ScalarField.ts` - 标量场
  - [ ] 2D/3D 标量场可视化
  - [ ] 颜色映射（heatmap）
  - [ ] 等值线（IsoLine）
- [ ] `core/gizmos/fields/VectorField.ts` - 向量场
  - [ ] 箭头网格
  - [ ] 流线（Streamline）
- [ ] `core/gizmos/fields/SampleProbe.ts` - 鼠标采样
  - [ ] 交互式探索场
  - [ ] 显示采样点数值

#### F2. Plot View
- [ ] `views/PlotView.ts` - 曲线视图
  - [ ] 2D 曲线绘制（Canvas/SVG）
  - [ ] 多条曲线叠加
  - [ ] 坐标轴/网格/标签
  - [ ] 缩放/平移
- [ ] 或简化为 Inspector 表格版（先低成本）

**验收标准**：
- 梯度下降：参数点移动 + loss 下降曲线
- 标量场：鼠标移动显示数值

---

### 🎓 Milestone G：第一批跨领域示例课程（2 周）

**目标**：验证平台跨领域能力

**交付物**：
- [ ] **几何**：点积投影（vector projection + angle + measure）
- [ ] **图算法**：BFS（frontier/visited step-by-step）
- [ ] **数值**：梯度下降（loss field + trajectory + loss curve）
- [ ] **系统**：DAG 调度（任务依赖 + timeline clips）
- [ ] **图形学**：Ray–Plane/Ray–Triangle 最近命中（t 与交点 + state）

**验收标准**：
- 5 个课程全部只用 DSL 实现
- 每个课程有完整文档
- 跨领域积木复用率 > 70%

---

## 📋 第一周任务单（快速启动）

### Week 1：最小可运行原型

**目标**：搭建骨架 + 第一个 DSL 驱动的 demo

#### Day 1-2：项目骨架
- [ ] Vite + TS 项目初始化
- [ ] Shell 布局（左目录/中视窗/右面板/底时间轴占位）
- [ ] ViewHost 基础框架

#### Day 3-4：Gizmo v0 + SemanticGraph
- [ ] BaseGizmo + GizmoFactory
- [ ] Point / Arrow / Label 实现
- [ ] SemanticEntity / SemanticGraph 基础模型
- [ ] SelectionStore（选中联动）

#### Day 5：Timeline v0
- [ ] TimelineRuntime（play/pause/step）
- [ ] Timeline Editor 最小版（markers 列表 + 时间条）

#### Day 6-7：第一个 DSL 示例
- [ ] DSL Parser（最小版，只解析 entities）
- [ ] 点积投影 DSL（vector-dot.yaml）
- [ ] 编译 DSL → SemanticGraph → Gizmos
- [ ] 运行验证

**Week 1 验收**：
- 一个 DSL 文件驱动的点积投影 demo 可运行
- 可点击选中实体，Inspector 显示属性
- Timeline 可播放/暂停

---

## 🎯 优先级排序

### 🔥 P0（核心路径，必须完成）
1. Milestone A - 平台壳 + 多视图
2. Milestone B - 积木 v0
3. Milestone C - Timeline Runtime + Editor
4. Milestone D - DSL + Compiler + Validator
5. Milestone G - 第一批示例课程

### 🔶 P1（重要，尽快完成）
6. Milestone E - Process 模型
7. Milestone F - Field + Plot

### 🔷 P2（增强，后续迭代）
8. 输入系统（拖拽/拾取）
9. 资源管理（缓存/复用）
10. 调试工具（Stats/Logger）
11. 性能优化

### 🔹 P3（可选，长期规划）
12. 协作功能（WebSocket 同步）
13. VR/AR 支持
14. Shader 编辑器

---

## 📐 工程规范

### Lesson 开发规范
1. **Lesson 只允许 DSL**，不允许直接写 Three.js 逻辑
2. **禁止硬编码坐标**，使用语义锚点（center/camera/intersection）
3. **所有对象都有稳定 ID**，Selection 与 Binding 依赖 ID
4. **Timeline 只改"展示"，Process 只管"过程"**

### Gizmo 开发规范
1. **必须继承 BaseGizmo**
2. **必须实现 dispose()**（几何/材质/事件监听都释放）
3. **必须支持 updateFromSemantic()**（语义属性更新）
4. **不暴露 Three.js 对象**，只暴露语义接口

### DSL 设计规范
1. **可解析**：JSON Schema 验证
2. **可验证**：语义级错误检查
3. **可 patch**：支持增量修改
4. **错误可读**：面向 AI/作者的错误提示

---

## 📊 成功指标

| 指标 | 目标 | 测量方法 |
|------|------|---------|
| **新增 Lesson 方式** | 只写 DSL 文件 | 验收标准 |
| **跨领域示例数** | ≥ 5 个 | 课程数量 |
| **积木复用率** | > 70% | 代码分析 |
| **DSL 错误处理** | 不崩溃 + 语义提示 | 错误测试 |
| **Timeline 可编辑** | 拖拽 + 保存 | 功能测试 |
| **AI 友好度** | 可生成/patch DSL | AI 测试 |

---

## 🔗 相关文档

- **[架构设计方案.md](./架构设计方案.md)** ⭐ 必读
  - 三层架构详解
  - 积木系统设计
  - DSL 规范
  - Process 模型

---

## 📈 里程碑时间估算

| Milestone | 预计时间 | 依赖 | 风险 |
|-----------|---------|------|------|
| A - 平台壳 + 多视图 | 2 周 | 无 | 低 |
| B - 积木 v0 | 3 周 | A | 中（抽象设计）|
| C - Timeline | 3 周 | B | 中（编辑器 UI）|
| D - DSL + Compiler | 4 周 | C | 高（编译器复杂）|
| E - Process 模型 | 3 周 | D | 中 |
| F - Field + Plot | 3 周 | E | 中 |
| G - 示例课程 | 2 周 | F | 低 |

**总计**：核心功能约 20 周（5 个月）

---

## 💡 开发建议

### 每新增一个示例，先问：
1. **缺积木还是缺模板？** → 优先补积木/模板
2. **能否用现有积木组合？** → 优先复用
3. **是否需要新 Process 类型？** → 评估通用性

### 常见陷阱
❌ **不要**在 DSL 中硬编码世界坐标
✅ **应该**使用语义锚点（center/camera/intersection）

❌ **不要**在 Gizmo 中暴露 Three.js 对象
✅ **应该**只暴露语义接口（setDirection/setColor）

❌ **不要**在 Timeline 中写算法逻辑
✅ **应该**算法逻辑在 Process，Timeline 只管展示

---

**最后更新**：2026-02-28
**维护者**：开发团队
**版本**：v2.0（通用平台版）
