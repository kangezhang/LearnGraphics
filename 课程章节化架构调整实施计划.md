# 课程章节化架构调整 TODO（Course -> Chapter）

## 0. 使用说明（先读）
- 本文档是唯一执行看板，按 `Phase` 推进。
- 每次开发（无论代码量大小）都必须同步更新本文档。
- 任务状态仅用：`[ ]` 未开始、`[x]` 已完成。
- 若中断开发，必须在“阻塞/风险”与“开发日志”记录当前状态。

## 1. 总览看板

| Phase | 名称 | 状态 | 负责人 | 备注 |
|---|---|---|---|---|
| P0 | 基线冻结与范围确认 | [ ] | Codex | 固化“课程->章节”约束 |
| P1 | 领域模型与类型改造 | [ ] | Codex | 引入 CoursePackage |
| P2 | Schema 与脚本兼容升级 | [ ] | Codex | `segments/sections -> chapters` |
| P3 | 存储模型迁移（Lesson -> Course） | [ ] | Codex | 兼容历史 localStorage |
| P4 | 运行时主流程改造（main） | [ ] | Codex | 章节切换与 timeline 重绑 |
| P5 | UI/Shell 交互改造 | [ ] | Codex | 左侧课程-章节导航 |
| P6 | AI 编排与解析改造 | [ ] | Codex | 课程包契约落地 |
| P7 | 回归、文档收口与去兼容计划 | [ ] | Codex | 快照/README/路线图同步 |

---

## 2. 全局强制步骤（每次开发都要做）

### 2.1 开发前
- [ ] 在“开发日志”新增一条记录（日期、目标 Phase、计划改动文件）。
- [ ] 标记对应 Phase 为进行中（在总览表备注中写 `in progress`）。

### 2.2 开发后（必须）
- [ ] 勾选本次完成的 TODO 子项。
- [ ] 更新总览看板状态（未完成/进行中/完成）。
- [ ] 在“开发日志”补充：实际改动文件、验证结果、遗留问题、下一步。
- [ ] 若改动 schema 或协议：同步更新“影响清单”。
- [ ] 若出现偏离：在“变更决策记录”写明原因和替代方案。

---

## 3. Phase 细分 TODO

## P0 基线冻结与范围确认
**目标**：冻结本轮只做“课程->章节”，timeline 仅章节内变化。

### 开发任务
- [ ] P0-1 在架构文档中写入冻结约束（不引入段落层）。
- [ ] P0-2 明确非目标（不做 clip 分镜系统、不做后端重构）。
- [ ] P0-3 输出术语表（Course/Chapter/LessonDSL 的关系）。

### 验收标准
- [ ] A0-1 团队文档中不存在“segments/sections 作为运行时层级”的表述。

---

## P1 领域模型与类型改造
**目标**：代码层引入课程与章节一等模型，保持编译链路可复用。

### 开发任务
- [ ] P1-1 在 `src/ai/types.ts` 增加 `CourseMeta/CourseChapter/CoursePackage`。
- [ ] P1-2 新增 `StoredAICourse`、`StoredAICourseRevision` 类型。
- [ ] P1-3 提供 `LessonDSL -> CoursePackage(单章节)` 适配器。
- [ ] P1-4 标记旧 `StoredAILesson` 为兼容路径（不立即删除）。

### 验收标准
- [ ] A1-1 TS 编译通过。
- [ ] A1-2 旧课程可被包装为单章节课程对象。

---

## P2 Schema 与脚本兼容升级
**目标**：协议从段落化改为章节化，并保留向后兼容读取。

### 开发任务
- [ ] P2-1 新增 `content/ai/schemas/course-package.schema.json`。
- [ ] P2-2 更新 `course-plan.schema.json`：`segments -> chapters`。
- [ ] P2-3 更新 `lesson-package.schema.json`：`lesson_script.sections -> chapter_scripts`。
- [ ] P2-4 更新 `scripts/generate-lesson-package.mjs` 的输入输出契约。
- [ ] P2-5 修正章节 marker 时间为累计时间（非单段时长）。

### 验收标准
- [ ] A2-1 `npm run check:ai-assets` 通过。
- [ ] A2-2 课程包示例可通过新 schema 校验。

---

## P3 存储模型迁移（Lesson -> Course）
**目标**：本地存储升级为课程包，历史数据自动迁移可读。

### 开发任务
- [ ] P3-1 `src/ai/LessonStore.ts` 升级为课程存储结构。
- [ ] P3-2 实现迁移函数：旧 `lg.ai.lessons.v1` -> 新 course 格式。
- [ ] P3-3 保留回滚链路（revision + orchestration metadata）。
- [ ] P3-4 为迁移失败提供降级与错误提示。

### 验收标准
- [ ] A3-1 老数据升级后可正常显示并可切章（单章也视为通过）。
- [ ] A3-2 版本面板不丢失历史 revision 信息。

---

## P4 运行时主流程改造（main）
**目标**：主流程从 `switchLesson` 改为 `switchCourse/switchChapter`。

### 开发任务
- [ ] P4-1 在 `src/main.ts` 引入 `LoadedCourse/LoadedChapter`。
- [ ] P4-2 将构建逻辑改为“加载课程后默认首章”。
- [ ] P4-3 新增 `switchChapter(courseId, chapterId)` 并复用现有 runtime 清理逻辑。
- [ ] P4-4 timeline 绑定改为当前章节 runtime。
- [ ] P4-5 doc 展示改为“课程标题 + 章节标题 + 章节文档”。

### 验收标准
- [ ] A4-1 切章后 graph/runtime/doc 同步刷新。
- [ ] A4-2 章节 A 的 timeline 不影响章节 B。

---

## P5 UI/Shell 交互改造
**目标**：左侧导航支持课程-章节层级，交互语义明确；新增顶部章节横向轨道用于快速切章。

### 交互规范（冻结）
- 章节导航放在中间主视图区顶部（不占用右侧 Inspector）。
- 导航形态为“横向章节卡片轨道”（Chapter Rail）。
- 支持鼠标拖拽左右滚动轨道，支持滚轮横向滚动。
- 点击章节卡片立即切换章节（触发 `switchChapter`）。
- 当前章节卡片必须高亮，切换后自动滚动到可见区域。
- 章节较多时允许横向溢出滚动，不换行。
- 移动端/窄屏下仍保持横向滚动，不降级为多行。

### 开发任务
- [ ] P5-1 `Shell.setLessons` 升级为 `setCourses`。
- [ ] P5-2 左侧列表支持课程展开/折叠与章节点击。
- [ ] P5-3 高亮状态改为当前章节。
- [ ] P5-4 AI 操作作用域明确（当前课程/当前章节）。
- [ ] P5-5 版本面板补充课程维度信息（章节数、当前章节）。
- [ ] P5-6 在主视图区顶部新增 `Chapter Rail` 容器与样式。
- [ ] P5-7 实现轨道拖拽滚动（按下拖动移动 scrollLeft）。
- [ ] P5-8 实现章节卡片点击切换并与主流程联动。
- [ ] P5-9 实现“当前章节自动滚动到可见区”（`scrollIntoView` 或等价逻辑）。
- [ ] P5-10 实现滚轮横向滚动与窄屏适配。

### 验收标准
- [ ] A5-1 UI 可稳定在课程与章节间导航。
- [ ] A5-2 无错误高亮或错绑 timeline 情况。
- [ ] A5-3 用户可通过“拖动章节轨道”完成左右浏览。
- [ ] A5-4 用户可通过“点击章节卡片”在 1 次交互内切章成功。
- [ ] A5-5 章节切换后，当前章节卡片始终可见且高亮。

---

## P6 AI 编排与解析改造
**目标**：AI 全链路输出课程章节化产物，前端可直接消费。

### 开发任务
- [ ] P6-1 `src/ai/CourseOrchestrator.ts` 支持课程包解析与落地。
- [ ] P6-2 `src/ai/LessonAIService.ts` prompt 改为章节化指令。
- [ ] P6-3 pipeline 响应支持新契约字段并兼容旧字段。
- [ ] P6-4 更新 `content/ai/examples/*` 为章节化样本。
- [ ] P6-5 更新 `content/ai/regression/*` 快照基线。

### 验收标准
- [ ] A6-1 AI 创建得到多章节课程且可切换。
- [ ] A6-2 AI 更新只影响目标章节或明确策略影响范围。

---

## P7 回归、文档收口与去兼容计划
**目标**：确保质量闭环，文档与实现完全对齐。

### 开发任务
- [ ] P7-1 跑通回归：`check-course-plan-snapshots`。
- [ ] P7-2 跑通回归：`check-lesson-package-snapshots`。
- [ ] P7-3 更新 `README.md`。
- [ ] P7-4 更新 `开发路线图.md`。
- [ ] P7-5 更新 `架构设计方案.md`。
- [ ] P7-6 更新 `架构对齐审查.md`（新增章节化审查条目）。
- [ ] P7-7 制定旧字段去兼容时间点与回滚策略。

### 验收标准
- [ ] A7-1 文档、schema、代码三者一致。
- [ ] A7-2 无关键路径依赖旧 `segments/sections` 字段。

---

## 4. 影响清单（持续维护）

### 代码
- [ ] `src/main.ts`
- [ ] `src/app/Shell.ts`
- [ ] `src/ai/types.ts`
- [ ] `src/ai/LessonStore.ts`
- [ ] `src/ai/CourseOrchestrator.ts`
- [ ] `src/ai/LessonAIService.ts`

### Schema / 资产
- [ ] `content/ai/schemas/course-plan.schema.json`
- [ ] `content/ai/schemas/lesson-package.schema.json`
- [ ] `content/ai/schemas/course-package.schema.json`（新增）
- [ ] `content/ai/examples/*`
- [ ] `content/ai/regression/*`

### 脚本
- [ ] `scripts/generate-lesson-package.mjs`
- [ ] `scripts/check-course-plan-snapshots.mjs`
- [ ] `scripts/check-lesson-package-snapshots.mjs`

### 文档
- [ ] `README.md`
- [ ] `开发路线图.md`
- [ ] `架构设计方案.md`
- [ ] `架构对齐审查.md`

---

## 5. 变更决策记录（ADR-lite）

> 发生架构偏移时追加，不得覆盖历史。

- [ ] 暂无

模板：
```md
### DECISION-YYYYMMDD-01
- 背景：
- 决策：
- 影响范围：
- 备选方案：
- 回滚方案：
```

---

## 6. 阻塞 / 风险跟踪

- [ ] 暂无

模板：
```md
- [ ] RISK-YYYYMMDD-01
  - 描述：
  - 影响：
  - 临时措施：
  - 解除条件：
```

---

## 7. 开发日志（每次开发必须更新）

### LOG-2026-02-28-01
- 目标 Phase：计划阶段（未进入代码实施）
- 计划改动：将实施计划重构为 TODO 看板，细分 phase 和强制文档更新步骤
- 实际改动文件：
  - `课程章节化架构调整实施计划.md`
- 验证：文档结构与 checklist 完整，包含全局强制步骤与 phase 验收
- 遗留问题：无
- 下一步：进入 P0/P1 开发时，先创建新日志再动代码

### LOG-2026-02-28-02
- 目标 Phase：P5 交互规格细化（仅文档）
- 计划改动：将“顶部章节横向拖动 + 点击切换”固化为冻结交互规范与 TODO 子任务
- 实际改动文件：
  - `课程章节化架构调整实施计划.md`
- 验证：P5 已新增交互规范、P5-6~P5-10 任务与 A5-3~A5-5 验收项
- 遗留问题：未开始代码实现
- 下一步：进入 P5 开发时按新增任务逐项落地并回填状态

---

当前状态：`TODO 看板已建立，代码实施尚未开始`。
