# 架构对齐审查（2026-02-26 / 2026-02-27 / 2026-02-28）

## 范围
- 对照文档：`架构设计方案.md`、`开发路线图.md`
- 代码范围：`src/` 全链路（DSL -> Semantic -> Timeline -> Views/Gizmos -> AI 生成管道）
- 审查目标：确认实现是否对齐架构约束，并识别潜在问题

## 问题清单

| ID | 严重级别 | 结论 | 状态 |
|---|---|---|---|
| R1 | 高 | DSL 未知实体类型会被静默降级为 `node`，掩盖语义错误 | 已修复（2026-02-26） |
| R2 | 高 | 锚点表达式存在静默回退到 `center` 的路径，错误不可见 | 已修复（2026-02-26） |
| R3 | 高 | Timeline tick 未驱动主视图（3D/Graph/Inspector）状态更新，只有特例逻辑在 `main.ts` | 已修复（2026-02-26） |
| R4 | 高 | `TimelineRuntime.applySerialized()` 未恢复 `duration/loop` | 已修复（2026-02-26） |
| R5 | 中 | `arrow` 位置字段存在 `x/y/z` 与 `ox/oy/oz` 不一致 | 已修复（2026-02-26） |
| R6 | 中 | `LabelGizmo` 选中态重绘文本来源错误，可能丢失 label | 已修复（2026-02-26） |
| R7 | 中 | `ProjectionHelperGizmo.update()` 重建角标对象但未回接对象列表 | 已修复（2026-02-26） |
| R8 | 中 | `View3D.resize()` 为空实现，面板 resize 时渲染尺寸不同步 | 已修复（2026-02-26） |
| R9 | 中 | `InspectorView` 通过 `innerHTML` 渲染属性值，存在注入风险 | 已修复（2026-02-26） |
| R10 | 低 | Binding 产物未接入运行链路（编译有产出，执行未消费） | 已修复（2026-02-26） |

## 新增对齐目标（2026-02-27）

| ID | 严重级别 | 对齐目标 | 状态 |
|---|---|---|---|
| H1 | 高 | 语义层新增 `line/plane/model`，禁止未知类型静默通过 | 已完成（2026-02-27） |
| H2 | 高 | 渲染层补齐对应 Gizmo，确保 `updateFromSemantic()` 与释放逻辑完整 | 已完成（2026-02-27） |
| H3 | 中 | 参数化链路覆盖 `line/plane/model`（slider + expr + timeline） | 已完成（2026-02-27） |
| H4 | 中 | 补充 DSL 示例与课程文档，验证“仅 DSL 可搭建场景” | 已完成（2026-02-27） |
| H5 | 中 | Lesson Controls 与 Timeline 帧对齐（当前帧写 keyframe + playhead 回显） | 已完成（2026-02-27） |

## 修复顺序
1. R1 -> R2 -> R3 -> R4（高优先）
2. R5 -> R6 -> R7 -> R8 -> R9（中优先）
3. R10（Binding 运行链路接入，已完成）

---

## AI 生成管道审查（2026-02-28）

### 问题清单

| ID | 严重级别 | 位置 | 问题描述 | 状态 |
|---|---|---|---|---|
| A1 | 高 | `src/ai/LessonAIService.ts:105` | API 响应 JSON 解析无 try-catch，非 JSON 响应将导致未捕获异常崩溃 | 已修复（2026-02-28） |
| A2 | 高 | `src/ai/LessonStore.ts:247-263` | 存储配额压缩静默删除历史版本，用户无感知、无法恢复 | 已修复（2026-02-28） |
| A3 | 中 | `src/semantic/compiler/DSLCompiler.ts` | 过程类型支持 `gd`/`gradient-descent`/`gradient_descent` 三种写法，语义不一致 | 已修复（2026-02-28） |
| A4 | 中 | `src/semantic/compiler/dslTypes.ts` | 关系端点支持 `source/from/vectorA/sourceId` 四种别名，可读性差 | 已修复（2026-02-28） |
| A5 | 中 | `src/main.ts:167-169` | 无可用课程时 `throw` 导致白屏崩溃，无降级路径 | 已修复（2026-02-28） |
| A6 | 中 | `src/ai/LessonAIService.ts:158-163` | `extractJSONObject` 假设花括号配对，嵌套 JSON 时可能截取错误区间 | 已修复（2026-02-28） |
| A7 | 高 | `src/ai/CourseOrchestrator.ts` | 统一编排层仅做服务转发，未把能力卡与规则结构化注入生成请求 | 已修复（2026-02-28） |
| A8 | 中 | `src/ai/LessonStore.ts:113` | 版本回滚会新建 head revision，但未继承编排元数据，审计链中断 | 已修复（2026-02-28） |
| A9 | 中 | `src/app/Shell.ts` / `src/main.ts` | 版本面板仅展示 revision，不展示能力快照与能力选择范围 | 已修复（2026-02-28） |
| A10 | 中 | `src/ai/CapabilityRegistry.ts` | 能力卡/规则采用 eager 装载，首屏路径承担 AI 资产加载成本 | 已修复（2026-02-28） |
| A11 | 高 | `src/ai/CourseOrchestrator.ts` / `src/app/Shell.ts` | 缺少后端 pipeline 编排模式，前端无法直连 `course_request -> course_plan -> lesson_package` 服务链路 | 已修复（2026-02-28） |
| A12 | 高 | `src/ai/CourseOrchestrator.ts` | pipeline 模式响应提取过于宽松，缺少固定契约与质量门禁拦截，存在错误内容落库风险 | 已修复（2026-02-28） |
| A13 | 高 | `src/ai/CourseOrchestrator.ts` / `src/ai/LessonAIService.ts` / `src/app/Shell.ts` | 课程更新缺少“能力快照漂移门禁”，且每次全量提交旧 DSL/文档可能造成高 token 成本 | 已修复（2026-02-28） |
| A14 | 高 | `src/main.ts` / `src/ai/LessonAIService.ts` | UI binding 的 `expr` 通过 `new Function` 执行，且 AI 配置含 `apiKey` 落地 localStorage，存在表达式注入后读取敏感配置风险 | 已修复（2026-02-28） |
| A15 | 中 | `src/ai/CourseOrchestrator.ts` | `pipeline` 模式在 endpoint 为空时静默回退到 `direct`，与配置语义不一致，排障困难 | 已修复（2026-02-28） |
| A16 | 低 | `src/app/Shell.ts` / `README.md` | 删除交互与文档“需双击确认”不一致，且非 AI 课程仍暴露删除入口 | 已修复（2026-02-28） |

### 审查结论
- AI 生成管道框架完整，持久化健壮性较好（版本历史、迁移、配额管理均有设计）
- 主要风险集中于：错误处理（A1）、数据安全感知（A2）、DSL 命名一致性（A3/A4）
- 本轮补充修复了表达式执行安全（A14）与交互契约一致性（A15/A16）
- `src/main.ts` 职责偏重（1000+ 行），但功能内聚尚可，暂不拆分

### 逐项修复记录（本轮）
1. A7（统一编排注入能力卡）  
   - 新增 `CapabilityRegistry`，从 `content/ai/capability-cards`、`capability-aliases`、`hard-rules` 组装结构化编排上下文。  
   - `DefaultCourseOrchestrator` 在 create/update 前先做能力选择，再将上下文注入 `LessonAIService`。  
   - 编排元数据新增 `capabilitySnapshotId/capabilityIds`，用于后续审计与回放。
2. A8（回滚审计链保留）  
   - `rollbackToRevision` 仍保持“回滚生成新 head revision”，并继承目标 revision 的编排元数据（若缺失则回退到当前 head 元数据）。
3. A9（版本面板可观测性）  
   - Version 面板新增编排快照信息：`capabilitySnapshotId` 与 `capabilityCount`，用于快速定位该版本依赖的能力集合。
4. A10（能力资产按需加载）  
   - `CapabilityRegistry` 改为异步按需加载：能力卡、别名、规则仅在 AI 创建/更新时加载并缓存。  
   - 降低首屏初始化路径负担，为长期扩展能力卡数量保留空间。
5. A11（后端 pipeline 编排模式）  
   - AI 设置新增 `orchestratorMode`（`direct|pipeline`）与 `orchestratorEndpoint`。  
   - `CourseOrchestrator` 新增 pipeline 请求分支：统一包装请求体、调用后端编排服务并提取 `dsl/docMarkdown`。  
   - 默认保持 `direct` 兼容，不影响现有直连模型模式。
6. A12（pipeline 固定契约与门禁）  
   - pipeline 响应改为固定契约校验：`lesson_package.dsl + lesson_package.doc_markdown`（可选 `request_id`、`quality_report`）。  
   - 当 `quality_report.hard_rule_pass=false` 时，前端直接阻断持久化并返回 violations。  
   - 新增契约 schema：`content/ai/schemas/orchestrator-response.schema.json`。
7. A13（更新门禁 + token 控制）  
   - 更新前新增能力快照漂移检查：快照缺失或不一致时，默认阻断更新，需用户显式 `Force update`。  
   - 新增 `CapabilityDriftError`，门禁失败在调用 AI 前返回，避免无效 token 消耗。  
   - `direct` 模式更新请求新增上下文压缩策略：超长 DSL/文档改为结构摘要 + 样本 + 截断正文。
8. A14（DSL 表达式执行安全）  
   - `compileBindingEvaluator` 新增表达式安全闸门：阻断 `window/globalThis/localStorage/constructor/eval/new` 等高危 token。  
   - 表达式编译改为 strict 模式，编译失败时降级为 `undefined` 并记录告警，避免异常中断运行链路。
9. A15（pipeline 配置语义）  
   - `resolveRuntimeMode` 改为严格遵循 `orchestratorMode`，`pipeline` 模式不再因 endpoint 缺失而静默回退。  
   - 当 `pipeline` endpoint 为空时直接报错，促使配置问题可观测、可定位。
10. A16（删除交互与文档对齐）  
   - 删除动作改为“仅 AI 课程启用”并要求在侧栏删除图标双击后才进入确认弹层。  
   - README 同步明确 `pipeline` 不再静默回退，确保文档与实现一致。

## 备注
- 修复过程中同步更新本审查文档状态。
- 每次代码修复完成后，同步更新主文档状态（`开发路线图.md`/`架构设计方案.md`/`README.md`）。

---

## 化学课程能力规划审查（2026-02-28，仅规划）

### 现状评估
- 平台具备通用 3D/关系/时间线表达能力，可用于化学课程原型搭建（结构演示、步骤播放、状态标注）。
- 平台暂缺化学领域语义原语（如 `atom/bond/molecule/reaction`）与化学专用 process。
- 文本/公式层对化学式支持不足（仅普通文本与轻量 markdown），不适合复杂化学式排版。

### 规划问题清单（待实施）

| ID | 严重级别 | 范围 | 问题描述 | 状态 |
|---|---|---|---|---|
| C1 | 高 | DSL/Semantic | 缺少化学语义实体类型（atom/bond/molecule）与一致的数据约束 | 规划中（2026-02-28） |
| C2 | 高 | Process | 缺少化学过程模型（反应路径/平衡迁移/速率统计） | 规划中（2026-02-28） |
| C3 | 中 | Validator | 缺少化学规则校验（键阶、价态、电荷平衡、引用一致性） | 规划中（2026-02-28） |
| C4 | 中 | UI/Doc | 缺少化学式友好渲染能力（下标/上标/离子电荷/反应箭头） | 规划中（2026-02-28） |
| C5 | 中 | AI Assets | 缺少 chemistry capability cards / 模板 / 回归快照 | 规划中（2026-02-28） |
| C6 | 低 | 示例课程 | 缺少化学主题示例 lesson，无法做端到端验证 | 规划中（2026-02-28） |

### 对齐结论
- 已完成“文档级规划对齐”：`架构设计方案.md` 与 `开发路线图.md` 已新增化学方向章节与里程碑（Milestone J）。
- 当前仍处于“先规划后实施”阶段，尚未进入代码变更与验证阶段。

### 实施前门禁（进入开发前必须满足）
1. `atom/bond/molecule/reaction` 的 DSL 字段草案冻结（v0）。
2. 至少 3 条化学 validator 规则达成团队共识。
3. 至少 2 个化学 process 的输入/输出契约定义完成。
4. 化学示例课程的维度覆盖矩阵（Structure/Energy/Electron/Statistics）评审通过。
